name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build-test-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm lint
        run: |
          helm lint ./helm/backend
          helm lint ./helm/nginx
          helm lint ./helm/postgres

      - name: Helm template (render check)
        run: |
          helm template backend ./helm/backend >/dev/null
          helm template nginx ./helm/nginx >/dev/null
          helm template postgres ./helm/postgres >/dev/null

      - name: Build & start app (docker compose)
        run: |
          docker compose up -d --build

      - name: Wait for app health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8081/api/health >/dev/null; then
              echo "Health OK"
              exit 0
            fi
            echo "Waiting... ($i)"
            sleep 2
          done
          echo "Health check failed"
          docker compose ps
          docker compose logs --no-color --tail=200
          exit 1

      - name: Smoke check login page (nginx -> frontend)
        run: |
          curl -fsS -I http://localhost:8081/login | head -n 5

      - name: Run backend tests (pytest) with migrations
        run: |
          docker compose run --rm backend sh -c "flask db upgrade && pytest -q"

      - name: Teardown
        if: always()
        run: |
          docker compose down -v